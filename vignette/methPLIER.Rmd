---
title: "The methPLIER User Guide"
author: "Ken Takasawa and Ryuji Hamamoto"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  prompt=FALSE,
  tidy=TRUE,
  message=FALSE,
  warning=FALSE,
  fig.width=8, fig.height=6, dpi = 600, 
  out.height = "100%", out.width = "100%"
)

library(knitr)
library(rmdformats)
library(tidyverse)
library(magrittr)
```

# Introduction
## What the methPLIER can do


# Installation
To install this package, start R (>= 3.5.0) and enter:
```{r}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

if (!require("methPLIER", quietly = TRUE))
    install.packages("methPLIER")
```

```{r}
library(methPLIER)
```

# Dataset
```{r}
data(gse39279.data, package = 'methPLIER')
data(gse39279.annot, package = 'methPLIER')
data(methPLIER, package = 'methPLIER')
```

## Data overview
```{r}
gse39279.data[1:5, 1:5]
gse39279.annot %>% head()
```

# Preparation for applying methPLIER function
## Get D matrix
```{r cache=TRUE}
D <- getDmatrix(gse39279.data)
```

```{r}
D[1:3, 1:5]
```

## Get B matrix
```{r}
B <- getNewDataB(D, methPLIER)
```

```{r}
B[1:3, 1:5]
```

# Unsupervised classification of B matrix
## Classify and plot Heatmap
```{r cache=TRUE, fig.width=8, fig.height=6}
ph <- plotHeatmap(B, k = 2, k.lv = 2)
```

```{r}
ph$cluster.sample
```

```{r}
ph$cluster.LV
```

# Plot survival plot with the result of clustering
```{r fig.width=8, fig.height=6}
cl <- ph$cluster.sample %>% inner_join(gse39279.annot) %>% 
  mutate(cluster = paste0('cluster_', cluster.sample),
         Event = 1) %>% 
  dplyr::rename(Time = TimeRec) %>% 
  dplyr::select(cluster, AccessionNo, Time, Event)
plotSurvival(cl)
```

# Get Top LVs
```{r}
topLV <- getTopLVs(ph$cluster.LV, '1', '2')
```

```{r}
topLV %>% arrange(q.value)
```

# Plot box plot of top 10 LVs
```{r fig.width=8, fig.height=6}
library(patchwork)
topLV %>% top_n(10, -q.value) %>% pull(LV) %>% 
  map(~ plotBoxplot(B, .x, ph$cluster.sample)) %>% 
  purrr::reduce(`+`) +
  plot_layout(ncol = 5, guides = 'collect')
```


# Get Differentially Methylated Genes (DMGs) of top LVs
```{r}
lv <- 386
dmg <- getDMGsInLV(methPLIER, D, lv, ph$cluster.sample)
```

```{r}
dmg %>% dim()
dmg %>% head()
```

# Get Differentially Methylated Probes (DMPs) of DMGs
```{r cache=TRUE}
dmp <- getDMPs(gse39279.data, ph$cluster.sample, base::unique(dmg$Gene), threshold = 0.05, method = 'fdr')
```

```{r}
dmp %>% head()
```


# Get Pathway of DMGs
```{r cache=TRUE}
pathway <- getPathway(dmg %>% distinct(Gene) %>% pull(Gene))
```

## Bar plot
```{r fig.width=8, fig.height=6}
pathway$barplot
```

## Dot plot
```{r fig.width=8, fig.height=6}
pathway$dotplot
```

## Tree plot
```{r fig.width=10, fig.height=6}
pathway$treeplot
```

# Gviz plot
## Make Gviz object
```{r cache=TRUE}
# Get gene list contained in the ontology 'Metastatic malignant neoplasm to brain'
gene.list <- pathway$edox2@result %>% top_n(1, -(qvalue)) %>% 
  pull(geneID) %>% str_split(., '\\/') %>% unlist()
gz <- gene.list %>% map(~ .x %>% makeGvizObj(., gse39279.data))
names(gz) <- gene.list
```

## Plot
```{r}
# Plot ERBB2 as example
gz$ERBB2 %>% plotGvizObj(.)

# If you want to plot all of the listed gene, execute below script.
## dir.create('figures/gviz_1/', recursive = TRUE)
## gz %>% imap(~ plotGvizObj(.x, filename = .y, dir = 'figures/gviz_1'))
```

## Plot Gviz with boxplot
```{r}
plotBoxplot.gviz(gz$ERBB2, as.factor(ph$cluster.sample$cluster.sample), 
                 gz$ERBB2$probe$TargetID[1:5])
```



# Session Information
```{r}
sessionInfo()
```

# Reference

